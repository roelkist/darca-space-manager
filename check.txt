ðŸ§ª Running tests...
============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-8.3.5, pluggy-1.5.0 -- /tmp/darca-space-venv/darca-space-manager-1MU3DrmL-py3.12/bin/python
cachedir: .pytest_cache
rootdir: /mnt/home/rokist/Projects/Python/darca-space-manager
configfile: pyproject.toml
plugins: cov-6.0.0, xdist-3.6.1
created: 12/12 workers
12 workers [18 items]

scheduling tests via LoadScheduling

tests/test_space_manager.py::test_list_and_count 
tests/test_space_manager.py::test_get_metadata_success 
tests/test_space_manager.py::test_duplicate_create 
tests/test_space_manager.py::test_delete_nonexistent 
tests/test_space_manager.py::test_create_space_exception 
tests/test_space_manager.py::test_delete_space 
tests/test_space_manager.py::test_list_spaces_exception 
tests/test_space_manager.py::test_metadata_only_delete 
tests/test_space_manager.py::test_create_space_metadata_none 
tests/test_space_manager.py::test_create_space_metadata_empty 
tests/test_space_manager.py::test_create_and_exist 
tests/test_space_manager.py::test_get_metadata_failure 
[gw2] [  5%] PASSED tests/test_space_manager.py::test_list_and_count 
tests/test_space_manager.py::test_read_metadata_exception 
[gw10] [ 11%] PASSED tests/test_space_manager.py::test_create_space_metadata_empty 
[gw9] [ 16%] PASSED tests/test_space_manager.py::test_create_space_metadata_none 
[gw0] [ 22%] PASSED tests/test_space_manager.py::test_create_and_exist 
tests/test_space_manager.py::test_save_metadata_exception 
[gw7] [ 27%] PASSED tests/test_space_manager.py::test_metadata_only_delete 
[gw3] [ 33%] PASSED tests/test_space_manager.py::test_get_metadata_success 
tests/test_space_manager.py::test_write_metadata_exception 
[gw6] [ 38%] PASSED tests/test_space_manager.py::test_delete_nonexistent 
[gw5] [ 44%] PASSED tests/test_space_manager.py::test_delete_space 
tests/test_space_manager.py::test_delete_metadata_failure 
[gw4] [ 50%] PASSED tests/test_space_manager.py::test_get_metadata_failure 
tests/test_space_manager.py::test_delete_metadata_file_missing 
[gw11] [ 55%] FAILED tests/test_space_manager.py::test_create_space_exception 
[gw4] [ 61%] PASSED tests/test_space_manager.py::test_delete_metadata_file_missing 
[gw8] [ 66%] PASSED tests/test_space_manager.py::test_list_spaces_exception 
[gw1] [ 72%] PASSED tests/test_space_manager.py::test_duplicate_create 
tests/test_space_manager.py::test_get_metadata_path_fail 
[gw2] [ 77%] PASSED tests/test_space_manager.py::test_read_metadata_exception 
[gw1] [ 83%] PASSED tests/test_space_manager.py::test_get_metadata_path_fail 
[gw0] [ 88%] PASSED tests/test_space_manager.py::test_save_metadata_exception 
[gw3] [ 94%] PASSED tests/test_space_manager.py::test_write_metadata_exception 
[gw5] [100%] PASSED tests/test_space_manager.py::test_delete_metadata_failure 

=================================== FAILURES ===================================
_________________________ test_create_space_exception __________________________
[gw11] linux -- Python 3.12.3 /tmp/darca-space-venv/darca-space-manager-1MU3DrmL-py3.12/bin/python

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7ef56ed526f0>
tmp_path = PosixPath('/tmp/pytest-of-rokist/pytest-47/popen-gw11/test_create_space_exception0')

    def test_create_space_exception(monkeypatch, tmp_path):
        """Simulate YamlUtils.save_yaml_file failure, rollback fails"""
        base_dir = tmp_path / "darca_space"
        monkeypatch.setattr(
            "darca_space_manager.config.DIRECTORIES",
            {
                "SPACE_DIR": str(base_dir / "spaces"),
                "METADATA_DIR": str(base_dir / "metadata"),
                "LOG_DIR": str(base_dir / "logs"),
            },
        )
        space_manager = SpaceManager()
        name = "failing_space"
    
        monkeypatch.setattr(
            "darca_space_manager.space_manager.DirectoryUtils.create_directory",
            lambda *_: True,
        )
        monkeypatch.setattr(
            "darca_space_manager.space_manager.YamlUtils.save_yaml_file",
            lambda *_: (_ for _ in ()).throw(Exception("force metadata fail")),
        )
        monkeypatch.setattr(
            "darca_space_manager.space_manager.DirectoryUtils.remove_directory",
            lambda *_: (_ for _ in ()).throw(Exception("rollback failed")),
        )
    
        with pytest.raises(SpaceManagerException, match="Failed to store metadata"):
>           space_manager.create_space(name, metadata={"some": "data"})

tests/test_space_manager.py:123: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/darca_space_manager/space_manager.py:135: in create_space
    DirectoryUtils.remove_directory(self._get_space_path(name))
tests/test_space_manager.py:119: in <lambda>
    lambda *_: (_ for _ in ()).throw(Exception("rollback failed")),
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

.0 = <tuple_iterator object at 0x7ef56ed528f0>

>       lambda *_: (_ for _ in ()).throw(Exception("rollback failed")),
    )
E   Exception: rollback failed

tests/test_space_manager.py:119: Exception

---------- coverage: platform linux, python 3.12.3-final-0 -----------
Name                                       Stmts   Miss  Cover
--------------------------------------------------------------
src/darca_space_manager/__init__.py            0      0   100%
src/darca_space_manager/__version__.py         3      3     0%
src/darca_space_manager/config.py              6      0   100%
src/darca_space_manager/space_manager.py      74      4    95%
--------------------------------------------------------------
TOTAL                                         83      7    92%
Coverage HTML written to dir htmlcov
Coverage JSON written to file coverage.json

=========================== short test summary info ============================
FAILED tests/test_space_manager.py::test_create_space_exception - Exception: rollback failed
========================= 1 failed, 17 passed in 1.27s =========================
